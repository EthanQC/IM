-- 用户表
CREATE TABLE IF NOT EXISTS users (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(32) NOT NULL UNIQUE COMMENT '用户名，唯一登录标识',
    password_hash VARCHAR(255) NOT NULL COMMENT 'bcrypt加密后的密码',
    phone VARCHAR(20) DEFAULT NULL UNIQUE COMMENT '手机号',
    email VARCHAR(100) DEFAULT NULL UNIQUE COMMENT '邮箱',
    display_name VARCHAR(64) NOT NULL COMMENT '显示名称/昵称',
    avatar_url VARCHAR(512) DEFAULT NULL COMMENT '头像URL',
    status TINYINT NOT NULL DEFAULT 1 COMMENT '账号状态: 0=禁用,1=正常,2=冻结',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL DEFAULT NULL COMMENT '软删除时间',
    KEY idx_username (username),
    KEY idx_phone (phone),
    KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户基础信息表';

-- 联系人表
CREATE TABLE IF NOT EXISTS contacts (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
    friend_id BIGINT UNSIGNED NOT NULL COMMENT '好友ID',
    remark VARCHAR(64) DEFAULT NULL COMMENT '好友备注',
    status TINYINT NOT NULL DEFAULT 1 COMMENT '关系状态: 0=已删除,1=正常,2=已拉黑',
    type TINYINT NOT NULL DEFAULT 1 COMMENT '联系人类型: 1=好友,2=陌生人',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_friend (user_id, friend_id),
    KEY idx_friend (friend_id),
    CONSTRAINT fk_contacts_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='联系人关系表';

-- 好友申请表
CREATE TABLE IF NOT EXISTS contact_applies (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    from_user_id BIGINT UNSIGNED NOT NULL COMMENT '申请人ID',
    to_user_id BIGINT UNSIGNED NOT NULL COMMENT '被申请人ID',
    message VARCHAR(255) DEFAULT NULL COMMENT '申请消息',
    status TINYINT NOT NULL DEFAULT 0 COMMENT '申请状态: 0=待处理,1=已同意,2=已拒绝,3=已过期',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_from_user (from_user_id),
    KEY idx_to_user (to_user_id),
    KEY idx_status (status),
    CONSTRAINT fk_apply_from_user FOREIGN KEY (from_user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_apply_to_user FOREIGN KEY (to_user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='好友申请表';

-- 黑名单表
CREATE TABLE IF NOT EXISTS blacklist (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
    blocked_user_id BIGINT UNSIGNED NOT NULL COMMENT '被拉黑用户ID',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_blocked (user_id, blocked_user_id),
    KEY idx_blocked_user (blocked_user_id),
    CONSTRAINT fk_blacklist_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='黑名单表';


-- 会话表
CREATE TABLE IF NOT EXISTS conversations (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    type TINYINT NOT NULL COMMENT '会话类型: 1=单聊,2=群聊',
    title VARCHAR(128) DEFAULT NULL COMMENT '会话标题(群聊名称)',
    avatar_url VARCHAR(512) DEFAULT NULL COMMENT '会话头像(群头像)',
    owner_id BIGINT UNSIGNED DEFAULT NULL COMMENT '群主ID(群聊时有效)',
    member_limit INT DEFAULT 500 COMMENT '成员上限',
    join_mode TINYINT NOT NULL DEFAULT 0 COMMENT '加入方式: 0=需要审批,1=自由加入',
    mute_all TINYINT NOT NULL DEFAULT 0 COMMENT '是否全员禁言: 0=否,1=是',
    status TINYINT NOT NULL DEFAULT 1 COMMENT '会话状态: 0=已解散,1=正常',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_owner (owner_id),
    KEY idx_type_status (type, status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='会话表';


-- 会话成员表
CREATE TABLE IF NOT EXISTS participants (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    conversation_id BIGINT UNSIGNED NOT NULL,
    user_id BIGINT UNSIGNED NOT NULL,
    role TINYINT NOT NULL DEFAULT 0 COMMENT '角色: 0=普通成员,1=管理员,2=群主',
    nickname VARCHAR(64) DEFAULT NULL COMMENT '群内昵称',
    muted TINYINT NOT NULL DEFAULT 0 COMMENT '是否禁言: 0=否,1=是',
    muted_until TIMESTAMP NULL DEFAULT NULL COMMENT '禁言截止时间',
    joined_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_read_seq BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '最后已读消息序号',
    UNIQUE KEY uk_conv_user (conversation_id, user_id),
    KEY idx_user (user_id),
    KEY idx_conv_role (conversation_id, role),
    CONSTRAINT fk_part_conv FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE,
    CONSTRAINT fk_part_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='会话成员表';


-- 消息表
CREATE TABLE IF NOT EXISTS messages (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    conversation_id BIGINT UNSIGNED NOT NULL,
    sender_id BIGINT UNSIGNED NOT NULL,
    client_msg_id VARCHAR(64) NOT NULL COMMENT '客户端消息ID,用于幂等',
    seq BIGINT UNSIGNED NOT NULL COMMENT '会话内消息序号',
    content_type TINYINT NOT NULL COMMENT '消息类型: 1=文本,2=图片,3=语音,4=视频,5=文件,6=位置,7=系统通知',
    content JSON NOT NULL COMMENT '消息内容JSON',
    status TINYINT NOT NULL DEFAULT 1 COMMENT '消息状态: 0=已撤回,1=正常,2=已删除',
    reply_to_msg_id BIGINT UNSIGNED DEFAULT NULL COMMENT '回复的消息ID',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_conv_seq (conversation_id, seq),
    UNIQUE KEY uk_sender_client (sender_id, client_msg_id),
    KEY idx_conv_time (conversation_id, created_at),
    KEY idx_sender (sender_id),
    CONSTRAINT fk_msg_conv FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE,
    CONSTRAINT fk_msg_sender FOREIGN KEY (sender_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='消息表';


-- 用户收件箱(记录每个用户在每个会话中的已读位置)
CREATE TABLE IF NOT EXISTS inbox (
    user_id BIGINT UNSIGNED NOT NULL,
    conversation_id BIGINT UNSIGNED NOT NULL,
    last_read_seq BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '最后已读消息序号',
    last_delivered_seq BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '最后投递消息序号',
    unread_count INT NOT NULL DEFAULT 0 COMMENT '未读消息数',
    is_muted TINYINT NOT NULL DEFAULT 0 COMMENT '是否免打扰: 0=否,1=是',
    is_pinned TINYINT NOT NULL DEFAULT 0 COMMENT '是否置顶: 0=否,1=是',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, conversation_id),
    KEY idx_conv_user (conversation_id, user_id),
    KEY idx_user_unread (user_id, unread_count),
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    event_type VARCHAR(64) NOT NULL COMMENT '事件类型: message.sent, message.read, etc.',
    aggregate_id VARCHAR(64) NOT NULL COMMENT '聚合根ID',
    conversation_id BIGINT UNSIGNED NOT NULL,
    message_id BIGINT UNSIGNED DEFAULT NULL,
    payload JSON NOT NULL COMMENT '事件负载',
    status TINYINT NOT NULL DEFAULT 0 COMMENT '发布状态: 0=待发布,1=已发布,2=失败',
    retry_count INT NOT NULL DEFAULT 0 COMMENT '重试次数',
    last_error TEXT DEFAULT NULL COMMENT '最后一次错误信息',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    published_at TIMESTAMP NULL DEFAULT NULL COMMENT '发布时间',
    KEY idx_status (status),
    KEY idx_conv (conversation_id),
    KEY idx_created (created_at),
    KEY idx_event_type (event_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='事务发件箱表'
status TINYINT NOT NULL DEFAULT 0, -- 0=pending,1=published,2=failed
retry_count INT NOT NULL DEFAULT 0,
created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
KEY idx_status (status),
KEY idx_conv (conversation_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


-- 文件附件表
CREATE TABLE IF NOT EXISTS attachments (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    object_key VARCHAR(255) NOT NULL UNIQUE COMMENT '对象存储中的key',
    original_name VARCHAR(255) NOT NULL COMMENT '原始文件名',
    uploader_id BIGINT UNSIGNED NOT NULL,
    size_bytes BIGINT UNSIGNED NOT NULL COMMENT '文件大小(字节)',
    content_type VARCHAR(128) NOT NULL COMMENT 'MIME类型',
    md5 CHAR(32) DEFAULT NULL COMMENT '文件MD5',
    width INT DEFAULT NULL COMMENT '图片/视频宽度',
    height INT DEFAULT NULL COMMENT '图片/视频高度',
    duration INT DEFAULT NULL COMMENT '音视频时长(秒)',
    metadata JSON NULL COMMENT '扩展元数据',
    status TINYINT NOT NULL DEFAULT 1 COMMENT '文件状态: 0=已删除,1=正常',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    KEY idx_uploader (uploader_id),
    KEY idx_created (created_at),
    CONSTRAINT fk_attachment_uploader FOREIGN KEY (uploader_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文件附件表';

-- 在线状态表(可以存在Redis中，这里仅作持久化备份)
CREATE TABLE IF NOT EXISTS user_presence (
    user_id BIGINT UNSIGNED PRIMARY KEY,
    status TINYINT NOT NULL DEFAULT 0 COMMENT '在线状态: 0=离线,1=在线,2=忙碌,3=离开',
    last_seen_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    device_id VARCHAR(128) DEFAULT NULL COMMENT '设备ID',
    platform VARCHAR(32) DEFAULT NULL COMMENT '平台: web, ios, android',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_status (status),
    KEY idx_last_seen (last_seen_at),
    CONSTRAINT fk_presence_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户在线状态表';

-- 消息已读回执表
CREATE TABLE IF NOT EXISTS message_receipts (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    message_id BIGINT UNSIGNED NOT NULL,
    user_id BIGINT UNSIGNED NOT NULL,
    read_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_msg_user (message_id, user_id),
    KEY idx_user (user_id),
    KEY idx_read_at (read_at),
    CONSTRAINT fk_receipt_msg FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE,
    CONSTRAINT fk_receipt_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='消息已读回执表';

-- 群组申请表
CREATE TABLE IF NOT EXISTS group_join_requests (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    conversation_id BIGINT UNSIGNED NOT NULL,
    user_id BIGINT UNSIGNED NOT NULL COMMENT '申请人ID',
    inviter_id BIGINT UNSIGNED DEFAULT NULL COMMENT '邀请人ID(如果是邀请)',
    message VARCHAR(255) DEFAULT NULL COMMENT '申请理由',
    status TINYINT NOT NULL DEFAULT 0 COMMENT '状态: 0=待审批,1=已同意,2=已拒绝',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_conv (conversation_id),
    KEY idx_user (user_id),
    KEY idx_status (status),
    CONSTRAINT fk_join_conv FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE,
    CONSTRAINT fk_join_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='群组加入申请表';